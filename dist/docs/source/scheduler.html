<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">'use strict';

<span id='Stimuli-core-Scheduler-method-constructor'><span id='Stimuli-core-Scheduler-cfg-delay'><span id='Stimuli-core-Scheduler-cfg-speed'><span id='Stimuli-core-Scheduler'>/**
</span></span></span></span> * @class Stimuli.core.Scheduler
 * @mixins Stimuli.core.Observable
 * @private
 * Provides a convenient way to &quot;buffer&quot; the emission of data.
 * @cfg {Number} speed The emission speed
 * @cfg {Number} delay The emission delay in ms
 * @constructor
 * Creates a new scheduler
 * @param {Object} config The config object
 */

(function() {

    Stimuli.core.Scheduler = function(options) {
        this.delay = options.delay || 1;
        this.speed = options.speed || 1;

        this.queue = [];
        this.locked = false;
    };

    var Scheduler = Stimuli.core.Scheduler;

    // Applies Observable mixin
    Stimuli.core.Class.mix(Stimuli.core.Scheduler, Stimuli.core.Observable);

<span id='Stimuli-core-Scheduler-method-schedule'>    /**
</span>     * Receives data to emit.
     * @param {Object} data The data to emit.
     */
    Scheduler.prototype.schedule = function(data, callback, options) {
        var self = this,
            frame = {data: data, callback: callback, options: options};

        if (options &amp;&amp; options.now) {
            self.queue.splice(0, 0, frame);
        } else {
            self.queue.push(frame);
        }

        self.emit();

    };

    Scheduler.prototype.calculateTimeout = function(options) {
        var delay = this.delay,
            speed = this.speed,
            timeout;

        if (options) {
            delay = !isNaN(options.delay) ? options.delay: delay;
            speed = !isNaN(options.speed) ? options.speed: speed;
        }

        return delay/speed;
    };

    Scheduler.prototype.skip = function() {
        this.locked = false;
        this.emit();
    };

<span id='Stimuli-core-Scheduler-method-emit'>    /**
</span>     * @private
     * Schedules emission of received data   
     */
    Scheduler.prototype.emit = function() {
        var self = this;
        if (self.locked || self.queue.length === 0) {
            return;
        }

        self.locked = true;

        var frame = self.queue.shift(),
            options = frame.options,
            data = frame.data,
            fn = frame.callback || function() {};

        var callback = function() {
            var args = Array.prototype.slice.call(arguments, 0);

            // asynchronous action callback
            if (fn.length &gt; args.length) {
                // adding a function as last argument to allow the execution
                // of the next device action
                args.push(function() {
                    self.locked = false;
                    self.emit();
                });

                fn.apply(self, args);
                // synchronous action callback
            } else {
                fn.apply(self, args);
                self.locked = false;
                self.emit();
            }

        };

        var timeout = self.calculateTimeout(options);

        if (timeout) {
            setTimeout(function() {
                self.publish('data', data, callback, options);
            }, timeout);
        } else {
            self.publish('data', data, callback, options);
        }


    };

})();</pre>
</body>
</html>
