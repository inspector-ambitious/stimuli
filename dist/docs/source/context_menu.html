<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">'use strict';

(function() {

    Stimuli.mouse.ContextMenu = function() {
        Stimuli.shared.Command.apply(this, arguments);
        this.parseArguments(arguments[1]);
    };

    var ContextMenu = Stimuli.mouse.ContextMenu;

    Stimuli.core.Class.mix(ContextMenu, Stimuli.shared.Command.prototype);
    Stimuli.core.Class.mix(ContextMenu, Stimuli.mouse.Helper);

    ContextMenu.prototype.execute = function(done) {

        var self = this,
            Obj = Stimuli.core.Object,
            defaultConf,
            target, position;

        return self

            .configure(function() {

                self.options.button = 'right';

                target = self.getTarget();

                if (target === null) {
                    throw new Error('Stimuli.mouse.contextmenu: invalid target.');
                }

                position = self.calculateViewportCoordinates(target, self.options);

                if (position === null) {
                    throw new Error('Stimuli.mouse.contextmenu: invalid position.');
                }

                defaultConf = {
                    button: self.getButton(),
                    bubbles: true,
                    cancelable: true,
                    altKey: self.viewport.getModifierState('Alt'),
                    ctrlKey: self.viewport.getModifierState('Control'),
                    shiftKey: self.viewport.getModifierState('Shift'),
                    metaKey: self.viewport.getModifierState('Meta'),
                    target: target,
                    details: 1,
                    clientX: position.clientX,
                    clientY: position.clientY,
                    screenX: position.screenX,
                    screenY: position.screenY
                };

            })

            .inject(function() {

                return Obj.merge({type: 'mousedown'}, defaultConf);

            })

            .then(function() {
                if (!self.isElementVisibleAt(target, position.clientX, position.clientY))  {
                    throw 'Stimuli.mouse.contextmenu: target disappeared on mousedown.';
                }
            })

            .inject(function() {

                return Obj.merge({type: 'mouseup'}, defaultConf);

            }, 100)

            .then(function() {
                if (!self.isElementVisibleAt(target, position.clientX, position.clientY))  {
                    throw 'Stimuli.mouse.contextmenu: target disappeared on mouseup.';
                }
            })

            .inject(function() {

                return Obj.merge({type: 'contextmenu'}, defaultConf);

            }, 1)

            .then(function() {
                self.viewport.waitForReady(done);
            });

    };

})();</pre>
</body>
</html>
